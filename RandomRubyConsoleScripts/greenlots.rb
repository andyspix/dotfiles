devs = Device.where(device_name: %w( 89148000004440722513 89148000004440722505 89148000004440722521 89148000004440722539 89148000004440722547 89148000004702741292 89148000004702740740 89148000004702741284 89148000004702740724 89148000004702740716 89148000004702740625 89148000004702740633 89148000004702740641 89148000004702740658 89148000004702740666 89148000004702740674 89148000004702740682 89148000004702740690 89148000004702740708 89148000004703430978 89148000004703430986 89148000004703430994 89148000004703431000 89148000004703431018 89148000004703430846 89148000004703430838 89148000004703430820 89148000004703430853 89148000004703430911 89148000004703430903 89148000004703430895 89148000004917889027 89148000004917889035 89148000004917889043 89148000004917889050 89148000004703430879 89148000004917889134 89148000004917889126 89148000004917889118 89148000004917889100 89148000004917889092 89148000004917888961 89148000004917888953 89148000004917888946 89148000004917888938 89148000004917888920 89148000004917888912 89148000004917888904 89148000004917888896 89148000004917888888 89148000004917888862 89148000004917888979 89148000004917888987 89148000004917888995 89148000004917889001 89148000004703430861 89148000004917888664 89148000004917888672 89148000004917888680 89148000004917888698 89148000004917888748 89148000004917888730 89148000004917888722 89148000004917895263 89148000004917895289 89148000004917895305 89148000004917895321 89148000004917895347 89148000004917895271 89148000004917895297 89148000004917895313 89148000004917895339 89148000004917895354 89148000004917895149 89148000004917895073 89148000004917895099 89148000004917895115 89148000004917895131 89148000004917895156 89148000004917888797 89148000004917888771 89148000004917894662 89148000004917894688 89148000004917894704 89148000004917894720 89148000004917894746 89148000004917894670 89148000004917894696 89148000004917894712 89148000004917894738 89148000004917894753 89148000004917894969 89148000004917894985 89148000004917895008 89148000004917895024 89148000004917895040 89148000004917894977 89148000004917894993 89148000004917895016 89148000004917895032 89148000004917895057 89148000004917894860 89148000004917894886 89148000004917894902 89148000004917894928 89148000004917894944 89148000004917894878 89148000004917894894 89148000004917894910 89148000004917894936 89148000004917894951 89148000004917895461 89148000004917895487 89148000004917896503 89148000004917895529 89148000004917895545 89148000004917895479 89148000004917895495 89148000004917895511 89148000004917895537 89148000004917895552 89148000004917393665 89148000004917393681 89148000004917393707 89148000004917393723 89148000004917393749 89148000004917393673 89148000004917393699 89148000004917393715 89148000004917393731 89148000004917393756 89148000004917394564 89148000004917394580 89148000004917394606 89148000004917394622 89148000004917394648 89148000004917394572 89148000004917394598 89148000004917394614 89148000004917394630 89148000004917394655 89148000004917393764 89148000004917393780 89148000004917393806 89148000004917393822 89148000004917393848 89148000004917393772 89148000004917393798 89148000004917393814 89148000004917393830 89148000004917393855 89148000004917393962 89148000004917393988 89148000004917394002 89148000004917394028 89148000004917394044 89148000004917393970 89148000004917393996 89148000004917394010 89148000004917394036 89148000004917394051 89148000004917393863 89148000004917393889 89148000004917393905 89148000004917393921 89148000004917393947 89148000004917393871 89148000004917393897 89148000004917393913 89148000004917393939 89148000004917393954 89148000004917394069 89148000004917394085 89148000004917394101 89148000004917394127 89148000004917394143 89148000004917394077 89148000004917394093 89148000004917394119 89148000004917394135 89148000004917394150 89148000004917394267 89148000004917394283 89148000004917394309 89148000004917394325 89148000004917394341 89148000004917394275 89148000004917394291 89148000004917394317 89148000004917394333 89148000004917394358 89148000004917394168 89148000004917394184 89148000004917394200 89148000004917394226 89148000004917394242 89148000004917394176 89148000004917394192 89148000004917394218 89148000004917394234 89148000004917394259 89148000004917394465 89148000004917394481 89148000004917394507 89148000004917394523 89148000004917394549 89148000004917394473 89148000004917394499 89148000004917394515 89148000004917394531 89148000004917394556 89148000004917394366 89148000004917394382 89148000004917394408 89148000004917394424 89148000004917394440 89148000004917394374 89148000004917394390 89148000004917394416 89148000004917394432 89148000004917394457 89148000004917684162 89148000004917684188 89148000004917684204 89148000004917684220 89148000004917684246 89148000004917684170 89148000004917684196 89148000004917684212 89148000004917684238 89148000004917684253 89148000004917683867 89148000004917683883 89148000004917683909 89148000004917683925 89148000004917683941 89148000004917683875 89148000004917683891 89148000004917683917 89148000004917683933 89148000004917683958 89148000004917683768 89148000004917683784 89148000004917683800 89148000004917683826 89148000004917683842 89148000004917683776 89148000004917683792 89148000004917683818 89148000004917683834 89148000004917683859 89148000004917683966 89148000004917683982 89148000004917684006 89148000004917684022 89148000004917684048 89148000004917683974 89148000004917683990 89148000004917684014 89148000004917684030 89148000004917684055 89148000004917684063 89148000004917684089 89148000004917684105 89148000004917684121 89148000004917684147 89148000004917684071 89148000004917684097 89148000004917684113 89148000004917684139 89148000004917684154 89148000004917894837 89148000004917894829 89148000004917894811 89148000004917894803 89148000004917894852 89148000004917894795 89148000004917894787 89148000004917895412 89148000004917278460 89148000004917278486 89148000004917278502 89148000004917278528 89148000004917278544 89148000004917278478 89148000004917278494 89148000004917278510 89148000004917278536 89148000004917278551 89148000004917278569 89148000004917278585 89148000004917278601 89148000004917278627 89148000004917278643 89148000004917278577 89148000004917278593 89148000004917278619 89148000004917278635 89148000004917278650 89148000004917278361 89148000004917278387 89148000004917278403 89148000004917278429 89148000004917278445 89148000004917278379 89148000004917278395 89148000004917278411 89148000004917278437 89148000004917278452 89148000004917278262 89148000004917278288 89148000004917278304 89148000004917278320 89148000004917278346 89148000004917278270 89148000004917278296 89148000004917278312 89148000004917278338 89148000004917278353 89148000004917278064 89148000004917278080 89148000004917278106 89148000004917278122 89148000004917278148 89148000004917278114 89148000004917278163 89148000004703430929 89148000004703430937 89148000004703430945 89148000004703430952 89148000004917277868 89148000004917277884 89148000004917277900 89148000004917277926 89148000004917277942 89148000004917277876 89148000004917277892 89148000004917277918 89148000004917277934 89148000004917277959 89148000004917277967 89148000004917277983 89148000004917278007 89148000004917278023 89148000004917278049 89148000004917277975 89148000004917277991 89148000004917278015 89148000004917278031 89148000004917278056 89148000004917278072 89148000004917278098 89148000004917278130 89148000004917278155 89148000004917278189 89148000004917278205 89148000004917278221 89148000004917278247 89148000004917278171 89148000004917278197 89148000004917278213 89148000004917278239 89148000004917278254))

billing_range = devs.map { |d| d.billing_histories.pluck(:created_at).map(&:to_date) }.flatten.uniq

all_rate_plans = devs.map { |d| d.billing_histories.pluck :rate_plan_id }.flatten.uniq

lifetime_usages = devs.map { |d| x = d.monthly_data_usages.sum(:bytes_used); [d.id, d.device_name, x, helper.number_to_human_size(x)] }

usages_map = BillingHistory.where(device_id: devs).where.not(rate_plan_id: [1, 461, 539, 1411, 1412]).group(:billing_period, :rate_plan_id).count

# ap usages_map.map { |x,y| [Date.parse(x.first.to_s).to_formatted_s(:month_and_year), helper.number_to_human_size(RatePlan.find(x.second).monthly_usage(Date.parse(x.first.to_s))), RatePlan.find(x.second).name_id, helper.number_to_human_size(y)].join(' , ') }

# RatePlan.where(id: [546, 1169, 1212, 1289])

##########
# Month, TotalBilled, RatePlan, Excess Billed
# April 2020 , 243 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 2.32 GB
# May 2020 , 292 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 27.5 GB
# June 2020 , 133 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 34.6 GB
# July 2020 , 220 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 33.2 GB
# August 2020 , 332 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 33.6 GB
# September 2020 , 223 GB , Greenlots-VZW-DIA-300MB (546) , 7.04 GB
# September 2020 , 0 Bytes , PickTrace VZW 500MB (638) , 4.51 GB
# September 2020 , 829 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 31.6 GB
# October 2020 , 297 GB , Greenlots-VZW-DIA-300MB (546) , 86.5 GB
# October 2020 , 0 Bytes , PickTrace VZW 500MB (638) , 3.54 GB
# October 2020 , 1.07 TB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 16.3 GB
# October 2020 , 121 GB , Greenlots :: VZWPublic :: (561) :: 5 GB (1212) , 14.6 GB
# November 2020 , 350 GB , Greenlots-VZW-DIA-300MB (546) , 140 GB
# November 2020 , 2.34 TB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 741 MB
# November 2020 , 222 GB , Greenlots :: VZWPublic :: (561) :: 5 GB (1212) , 26.2 GB
# December 2020 , 407 GB , Greenlots-VZW-DIA-300MB (546) , 203 GB
# December 2020 , 680 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 428 MB
# December 2020 , 639 GB , Greenlots :: VZWPublic :: (561) :: 5 GB (1212) , 20.1 GB
# December 2020 , 0 Bytes , Greenlots :: VZWPublic :: (639) :: 20 GB (1289) , 24.6 GB
# January 2021 , 444 GB , Greenlots-VZW-DIA-300MB (546) , 132 GB
# January 2021 , 420 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 199 MB
# January 2021 , 318 GB , Greenlots :: VZWPublic :: (561) :: 5 GB (1212) , 19.2 GB
# January 2021 , 0 Bytes , Greenlots :: VZWPublic :: (639) :: 20 GB (1289) , 152 GB
# February 2021 , 397 GB , Greenlots-VZW-DIA-300MB (546) , 136 GB
# February 2021 , 392 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 11.4 GB
# February 2021 , 275 GB , Greenlots :: VZWPublic :: (561) :: 5 GB (1212) , 18.4 GB
# February 2021 , 0 Bytes , Greenlots :: VZWPublic :: (639) :: 20 GB (1289) , 90.1 GB
# March 2021 , 414 GB , Greenlots-VZW-DIA-300MB (546) , 190 GB
# March 2021 , 305 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 6.13 GB
# March 2021 , 122 GB , Greenlots :: VZWPublic :: (561) :: 5 GB (1212) , 19.7 GB
# March 2021 , 0 Bytes , Greenlots :: VZWPublic :: (639) :: 20 GB (1289) , 83.2 GB
# April 2021 , 406 GB , Greenlots-VZW-DIA-300MB (546) , 276 GB
# April 2021 , 316 GB , Greenlots :: VZWPublic :: (518) :: 200 MB (1169) , 10 GB
# April 2021 , 80 GB , Greenlots :: VZWPublic :: (561) :: 5 GB (1212) , 20.5 GB
# April 2021 , 0 Bytes , Greenlots :: VZWPublic :: (639) :: 20 GB (1289) , 3.28 GB
#
    # [ Wed, 01 Apr 2020 00:00:00 UTC +00:00, 1169 ] => 11,
    # [ Fri, 01 May 2020 00:00:00 UTC +00:00, 1169 ] => 11,
    # [ Mon, 01 Jun 2020 00:00:00 UTC +00:00, 1169 ] => 11,
    # [ Wed, 01 Jul 2020 00:00:00 UTC +00:00, 1169 ] => 11,
    # [ Sat, 01 Aug 2020 00:00:00 UTC +00:00, 1169 ] => 11,
     # [ Tue, 01 Sep 2020 00:00:00 UTC +00:00, 546 ] => 20,
     # [ Tue, 01 Sep 2020 00:00:00 UTC +00:00, 638 ] => 10,
    # [ Tue, 01 Sep 2020 00:00:00 UTC +00:00, 1169 ] => 11,
     # [ Thu, 01 Oct 2020 00:00:00 UTC +00:00, 546 ] => 68,
     # [ Thu, 01 Oct 2020 00:00:00 UTC +00:00, 638 ] => 10,
    # [ Thu, 01 Oct 2020 00:00:00 UTC +00:00, 1169 ] => 11,
    # [ Thu, 01 Oct 2020 00:00:00 UTC +00:00, 1212 ] => 7,
     # [ Sun, 01 Nov 2020 00:00:00 UTC +00:00, 546 ] => 86,
    # [ Sun, 01 Nov 2020 00:00:00 UTC +00:00, 1169 ] => 6,
    # [ Sun, 01 Nov 2020 00:00:00 UTC +00:00, 1212 ] => 7,
     # [ Tue, 01 Dec 2020 00:00:00 UTC +00:00, 546 ] => 106,
    # [ Tue, 01 Dec 2020 00:00:00 UTC +00:00, 1169 ] => 6,
    # [ Tue, 01 Dec 2020 00:00:00 UTC +00:00, 1212 ] => 7,
    # [ Tue, 01 Dec 2020 00:00:00 UTC +00:00, 1289 ] => 10,
     # [ Fri, 01 Jan 2021 00:00:00 UTC +00:00, 546 ] => 87,
    # [ Fri, 01 Jan 2021 00:00:00 UTC +00:00, 1169 ] => 6,
    # [ Fri, 01 Jan 2021 00:00:00 UTC +00:00, 1212 ] => 7,
    # [ Fri, 01 Jan 2021 00:00:00 UTC +00:00, 1289 ] => 10,
     # [ Mon, 01 Feb 2021 00:00:00 UTC +00:00, 546 ] => 87,
    # [ Mon, 01 Feb 2021 00:00:00 UTC +00:00, 1169 ] => 7,
    # [ Mon, 01 Feb 2021 00:00:00 UTC +00:00, 1212 ] => 7,
    # [ Mon, 01 Feb 2021 00:00:00 UTC +00:00, 1289 ] => 9,
     # [ Mon, 01 Mar 2021 00:00:00 UTC +00:00, 546 ] => 78,
    # [ Mon, 01 Mar 2021 00:00:00 UTC +00:00, 1169 ] => 9,
    # [ Mon, 01 Mar 2021 00:00:00 UTC +00:00, 1212 ] => 7,
    # [ Mon, 01 Mar 2021 00:00:00 UTC +00:00, 1289 ] => 9,
     # [ Thu, 01 Apr 2021 00:00:00 UTC +00:00, 546 ] => 88,
    # [ Thu, 01 Apr 2021 00:00:00 UTC +00:00, 1169 ] => 9,
    # [ Thu, 01 Apr 2021 00:00:00 UTC +00:00, 1212 ] => 4,
    # [ Thu, 01 Apr 2021 00:00:00 UTC +00:00, 1289 ] => 9
