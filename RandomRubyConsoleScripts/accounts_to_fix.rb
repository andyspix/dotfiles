accounts = Account.where(account_number: %w(45873580-134293 12333475-619433 75134833-159074 88124576-830088 74276946-581653 40679474-239802 39333472-650787 89765540-126031 44673270-206896 51279001-243131 73977787-764445 50296523-108488 52544143-194102 28282838-717717 13910484-825295 33270376-952355 48729751-880239 26670943-366806 91698704-405385 79883992-257240 23623565-703881 48648265-200201 93189816-711389 15815284-841258 83628757-471026 28569008-345943 23067613-689599 91808807-684340 38563045-465711 58279899-414625 22207320-867038 66040419-684411 96738137-147460 11345200-921823 36926891-715470 59345440-804682 18022875-582319 73164534-123051 18591377-662533 82383662-549010 52068981-261073 80404894-366636 47931576-307155 78189437-950609 39465298-978263 17050468-179171 32989994-210882 44098072-521527 14726564-687348 58283177-201305 97141316-560718 26384385-937545 51858633-811017 48730552-227884 96438744-597258 95311272-556859 43134026-102811 71905685-857963 14774551-720675 69875252-304083 88956396-625188 82158979-823650 65281359-699424 85472499-895697 77545956-198070 41311373-354821 47462536-114634 90626130-793619 18273156-840096 46155548-235089 94105720-789809 67202604-843737))

date = Date.today.months_ago(1)
date -= (date.day - 5) # set to 5th day of month

# purge the bad histories, bad invoices, and bad detail sheets
BillingHistory.where(billing_period: date.beginning_of_month).delete_all;0
Invoice.where(billing_period_start: date.beginning_of_month).find_each(&:destroy);0
DetailSheet.where(date_posted: date.end_of_month).find_each(&:destroy);0

Device.pluck(:id).each { |d_id| BillingHistory.populate(date, device_id: d_id) };0
Account.find_each do |account|
  if Invoice.find_by(account_id: account.id, billing_period_start: date.beginning_of_month).nil? && !account.rate_plans.empty?
    Invoice.create(Invoice.generate(account.id, date))
  end
  account.delay.generate_detail_sheet_for(date.end_of_month)
end




